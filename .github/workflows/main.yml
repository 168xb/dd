name: IP Source Updater

on:
  push:
    paths:
      - 'Code/**'
      - 'data/**'
    branches: [ main, master ]  # 明确指定分支
  workflow_dispatch:

jobs:
  update_sources:
    runs-on: ubuntu-latest

    steps:
      # 第一步：调试输出（查看什么文件触发了工作流）
      - name: Debug changed files
        run: |
          echo "GITHUB_SHA: $GITHUB_SHA"
          echo "Changed files in this commit:"
          git diff-tree --no-commit-id --name-only -r $GITHUB_SHA
          echo "Current directory contents:"
          ls -R

      # 第二步：检出当前仓库
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史记录

      # 第三步：设置Python环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'
          cache: 'pip'  # 启用pip缓存

      # 第四步：安装依赖
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests futures eventlet aiohttp aiofiles asyncio

      # 第五步：准备目录结构
      - name: Prepare directories
        run: |
          mkdir -p ${{ github.workspace }}/txt
          echo "Directory structure:"
          tree -L 3

      # 第六步：运行主脚本
      - name: Execute main script
        run: |
          if [ -f "$GITHUB_WORKSPACE/Code/main.py" ]; then
            python $GITHUB_WORKSPACE/Code/main.py
          else
            echo "Error: main.py not found!"
            exit 1
          fi
          echo "Generated files:"
          ls -lh txt/

      # 第七步：清理源文件
      - name: Clean source files
        run: |
          echo "Cleaning source files..."
          find "$GITHUB_WORKSPACE/data" -name "*.ip" -type f -print -delete
          find "$GITHUB_WORKSPACE/Code" -name "*.py" -type f -print -delete
          echo "Remaining files:"
          find "$GITHUB_WORKSPACE/data" -type f
          find "$GITHUB_WORKSPACE/Code" -type f

      # 第八步：提交源仓库变更
      - name: Commit source changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "🔄 Update IP [skip ci]"
            git push
          fi

      # 第九步：检出目标仓库
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 168xb/jd
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: target_repo
          clean: false

      # 第十步：复制文件到目标仓库
      - name: Copy to target repo
        run: |
          echo "Copying files to target repo..."
          mkdir -p target_repo/itv
          if ls txt/*.txt 1> /dev/null 2>&1; then
            cp -v txt/*.txt target_repo/itv/
          else
            echo "No .txt files found to copy"
            exit 1
          fi

      # 第十一步：提交目标仓库变更
      - name: Commit target changes
        run: |
          cd target_repo
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add itv/
          if git diff-index --quiet HEAD --; then
            echo "No changes in target repo"
          else
            git commit -m "Update IP sources (automated)"
            git push
          fi

      # 第十二步：最终状态报告
      - name: Final report
        run: |
          echo "Workflow completed successfully"
          echo "Source repo changes:"
          git -C $GITHUB_WORKSPACE log -1 --oneline
          echo "Target repo changes:"
          git -C target_repo log -1 --oneline