name: IP Source Updater

on:
  push:
    paths:
      - 'Code/**'
      - 'data/**'
    branches: [ main, master ]  # æ˜ç¡®æŒ‡å®šåˆ†æ”¯
  workflow_dispatch:

jobs:
  update_sources:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šè°ƒè¯•è¾“å‡ºï¼ˆæŸ¥çœ‹ä»€ä¹ˆæ–‡ä»¶è§¦å‘äº†å·¥ä½œæµï¼‰
      - name: Debug changed files
        run: |
          echo "GITHUB_SHA: $GITHUB_SHA"
          echo "Changed files in this commit:"
          git diff-tree --no-commit-id --name-only -r $GITHUB_SHA
          echo "Current directory contents:"
          ls -R

      # ç¬¬äºŒæ­¥ï¼šæ£€å‡ºå½“å‰ä»“åº“
      - name: Checkout source repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•

      # ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.3'
          cache: 'pip'  # å¯ç”¨pipç¼“å­˜

      # ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install selenium requests futures eventlet aiohttp aiofiles asyncio

      # ç¬¬äº”æ­¥ï¼šå‡†å¤‡ç›®å½•ç»“æ„
      - name: Prepare directories
        run: |
          mkdir -p ${{ github.workspace }}/txt
          echo "Directory structure:"
          tree -L 3

      # ç¬¬å…­æ­¥ï¼šè¿è¡Œä¸»è„šæœ¬
      - name: Execute main script
        run: |
          if [ -f "$GITHUB_WORKSPACE/Code/main.py" ]; then
            python $GITHUB_WORKSPACE/Code/main.py
          else
            echo "Error: main.py not found!"
            exit 1
          fi
          echo "Generated files:"
          ls -lh txt/

      # ç¬¬ä¸ƒæ­¥ï¼šæ¸…ç†æºæ–‡ä»¶
      - name: Clean source files
        run: |
          echo "Cleaning source files..."
          find "$GITHUB_WORKSPACE/data" -name "*.ip" -type f -print -delete
          find "$GITHUB_WORKSPACE/Code" -name "*.py" -type f -print -delete
          echo "Remaining files:"
          find "$GITHUB_WORKSPACE/data" -type f
          find "$GITHUB_WORKSPACE/Code" -type f

      # ç¬¬å…«æ­¥ï¼šæäº¤æºä»“åº“å˜æ›´
      - name: Commit source changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add .
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ”„ Update IP [skip ci]"
            git push
          fi

      # ç¬¬ä¹æ­¥ï¼šæ£€å‡ºç›®æ ‡ä»“åº“
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: 168xb/jd
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: target_repo
          clean: false

      # ç¬¬åæ­¥ï¼šå¤åˆ¶æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“
      - name: Copy to target repo
        run: |
          echo "Copying files to target repo..."
          mkdir -p target_repo/itv
          if ls txt/*.txt 1> /dev/null 2>&1; then
            cp -v txt/*.txt target_repo/itv/
          else
            echo "No .txt files found to copy"
            exit 1
          fi

      # ç¬¬åä¸€æ­¥ï¼šæäº¤ç›®æ ‡ä»“åº“å˜æ›´
      - name: Commit target changes
        run: |
          cd target_repo
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add itv/
          if git diff-index --quiet HEAD --; then
            echo "No changes in target repo"
          else
            git commit -m "Update IP sources (automated)"
            git push
          fi

      # ç¬¬åäºŒæ­¥ï¼šæœ€ç»ˆçŠ¶æ€æŠ¥å‘Š
      - name: Final report
        run: |
          echo "Workflow completed successfully"
          echo "Source repo changes:"
          git -C $GITHUB_WORKSPACE log -1 --oneline
          echo "Target repo changes:"
          git -C target_repo log -1 --oneline